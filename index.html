<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì½”ë””ë©”ì´íŠ¸ - AI íŒ¨ì…˜ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(180deg, #1c1917 0%, #292524 100%); min-height: 100vh; margin: 0; }
    .glass-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
    .btn-primary { background: linear-gradient(135deg, #f19a3e 0%, #ed7d1a 100%); box-shadow: 0 4px 20px rgba(241,154,62,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); }
    .style-chip.selected { background: linear-gradient(135deg, #f19a3e 0%, #ed7d1a 100%); border-color: transparent; color: white; }
    .progress-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: all 0.3s; }
    .progress-dot.active { background: #f19a3e; width: 24px; border-radius: 4px; }
    .progress-dot.completed { background: #f19a3e; }
    .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-top-color: #f19a3e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease forwards; }
    input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; color: white; font-size: 18px; width: 100%; text-align: center; outline: none; }
    input:focus { border-color: #f19a3e; background: rgba(241,154,62,0.1); }
    input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .custom-tag { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #f19a3e, #ed7d1a); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; }
    .custom-tag button { background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .outfit-item { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s; }
    .outfit-item:hover { border-color: rgba(241,154,62,0.3); transform: translateX(4px); }
    .placeholder-image { background: linear-gradient(135deg, #2d2a26 0%, #1f1d1a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const GEMINI_API_KEY = 'AIzaSyAb8Wq-Eh7rzAk3ZsVpvJiL5ZXq_DTnuiU';
const GEMINI_TEXT_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

// ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ (ìµœì‹  ìˆœì„œ)
const IMAGE_MODELS = [
  'gemini-2.5-flash-image',
  'gemini-2.0-flash-preview-image-generation',
  'gemini-2.0-flash-exp'
];

// ë‚ ì”¨ ì½”ë“œ â†’ í•œê¸€ + ì´ëª¨ì§€ ë³€í™˜
const weatherCodeMap = {
  0: { condition: 'ë§‘ìŒ', icon: 'â˜€ï¸' },
  1: { condition: 'ëŒ€ì²´ë¡œ ë§‘ìŒ', icon: 'ğŸŒ¤ï¸' },
  2: { condition: 'êµ¬ë¦„ ì¡°ê¸ˆ', icon: 'â›…' },
  3: { condition: 'íë¦¼', icon: 'â˜ï¸' },
  45: { condition: 'ì•ˆê°œ', icon: 'ğŸŒ«ï¸' },
  48: { condition: 'ì§™ì€ ì•ˆê°œ', icon: 'ğŸŒ«ï¸' },
  51: { condition: 'ê°€ë²¼ìš´ ì´ìŠ¬ë¹„', icon: 'ğŸŒ¦ï¸' },
  53: { condition: 'ì´ìŠ¬ë¹„', icon: 'ğŸŒ¦ï¸' },
  55: { condition: 'ì§™ì€ ì´ìŠ¬ë¹„', icon: 'ğŸŒ§ï¸' },
  61: { condition: 'ì•½í•œ ë¹„', icon: 'ğŸŒ§ï¸' },
  63: { condition: 'ë¹„', icon: 'ğŸŒ§ï¸' },
  65: { condition: 'ê°•í•œ ë¹„', icon: 'ğŸŒ§ï¸' },
  71: { condition: 'ì•½í•œ ëˆˆ', icon: 'ğŸŒ¨ï¸' },
  73: { condition: 'ëˆˆ', icon: 'â„ï¸' },
  75: { condition: 'ê°•í•œ ëˆˆ', icon: 'â„ï¸' },
  77: { condition: 'ì§„ëˆˆê¹¨ë¹„', icon: 'ğŸŒ¨ï¸' },
  80: { condition: 'ì†Œë‚˜ê¸°', icon: 'ğŸŒ¦ï¸' },
  81: { condition: 'ì†Œë‚˜ê¸°', icon: 'ğŸŒ§ï¸' },
  82: { condition: 'ê°•í•œ ì†Œë‚˜ê¸°', icon: 'â›ˆï¸' },
  95: { condition: 'ë‡Œìš°', icon: 'â›ˆï¸' },
  96: { condition: 'ìš°ë°• ë™ë°˜ ë‡Œìš°', icon: 'â›ˆï¸' },
  99: { condition: 'ê°•í•œ ìš°ë°• ë‡Œìš°', icon: 'â›ˆï¸' }
};

const styleCategories = [
  { category: 'ë² ì´ì§', options: [{ id: 'minimal', label: 'ë¯¸ë‹ˆë©€', emoji: 'â—»ï¸' }, { id: 'casual', label: 'ìºì£¼ì–¼', emoji: 'ğŸ‘•' }, { id: 'basic', label: 'ë² ì´ì§', emoji: 'âšª' }, { id: 'clean', label: 'í´ë¦°í•', emoji: 'âœ¨' }] },
  { category: 'íŠ¸ë Œë””', options: [{ id: 'street', label: 'ìŠ¤íŠ¸ë¦¿', emoji: 'ğŸ§¢' }, { id: 'hiphop', label: 'í™í•©', emoji: 'ğŸ¤' }, { id: 'y2k', label: 'Y2K', emoji: 'ğŸ’¿' }, { id: 'techwear', label: 'í…Œí¬ì›¨ì–´', emoji: 'ğŸ¦¾' }, { id: 'gorpcore', label: 'ê³ í”„ì½”ì–´', emoji: 'ğŸ”ï¸' }] },
  { category: 'í¬ë©€/í´ë˜ì‹', options: [{ id: 'formal', label: 'í¬ë©€', emoji: 'ğŸ‘”' }, { id: 'business', label: 'ë¹„ì¦ˆìºì£¼ì–¼', emoji: 'ğŸ’¼' }, { id: 'preppy', label: 'í”„ë ˆí”¼', emoji: 'ğŸ“' }, { id: 'oldmoney', label: 'ì˜¬ë“œë¨¸ë‹ˆ', emoji: 'ğŸ’°' }, { id: 'classic', label: 'í´ë˜ì‹', emoji: 'ğŸ©' }] },
  { category: 'ìºì£¼ì–¼', options: [{ id: 'sporty', label: 'ìŠ¤í¬í‹°', emoji: 'ğŸƒ' }, { id: 'athleisure', label: 'ì• ìŠ¬ë ˆì €', emoji: 'ğŸ§˜' }, { id: 'outdoor', label: 'ì•„ì›ƒë„ì–´', emoji: 'â›º' }, { id: 'workwear', label: 'ì›Œí¬ì›¨ì–´', emoji: 'ğŸ”§' }] },
  { category: 'ê°ì„±', options: [{ id: 'romantic', label: 'ë¡œë§¨í‹±', emoji: 'ğŸŒ¸' }, { id: 'vintage', label: 'ë¹ˆí‹°ì§€', emoji: 'ğŸ“»' }, { id: 'bohemian', label: 'ë³´í—¤ë¯¸ì•ˆ', emoji: 'ğŸª¶' }, { id: 'grunge', label: 'ê·¸ëŸ°ì§€', emoji: 'ğŸ¸' }, { id: 'dark', label: 'ë‹¤í¬ì›¨ì–´', emoji: 'ğŸ–¤' }] },
  { category: 'í•˜ì´ì—”ë“œ', options: [{ id: 'luxury', label: 'ëŸ­ì…”ë¦¬', emoji: 'ğŸ’' }, { id: 'avantgarde', label: 'ì•„ë°©ê°€ë¥´ë“œ', emoji: 'ğŸ­' }, { id: 'minimalchic', label: 'ë¯¸ë‹ˆë©€ì‹œí¬', emoji: 'ğŸ”²' }] }
];

const Icons = {
  Home: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  Closet: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/></svg>,
  Trend: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
  Profile: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  Refresh: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
  Cart: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
  Chevron: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
  Location: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
};

// ì‹¤ì‹œê°„ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° (Open-Meteo API - ë¬´ë£Œ, í‚¤ ë¶ˆí•„ìš”)
async function fetchWeather(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
    const res = await fetch(url);
    const data = await res.json();
    
    const code = data.current.weather_code;
    const weatherInfo = weatherCodeMap[code] || { condition: 'ì•Œ ìˆ˜ ì—†ìŒ', icon: 'ğŸŒ¡ï¸' };
    
    return {
      temperature: Math.round(data.current.temperature_2m),
      tempMax: Math.round(data.daily.temperature_2m_max[0]),
      tempMin: Math.round(data.daily.temperature_2m_min[0]),
      condition: weatherInfo.condition,
      icon: weatherInfo.icon,
      humidity: data.current.relative_humidity_2m,
      wind: data.current.wind_speed_10m
    };
  } catch (e) {
    console.error('Weather fetch error:', e);
    return null;
  }
}

// ìœ„ì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì—­ì§€ì˜¤ì½”ë”©)
async function fetchLocationName(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ko`;
    const res = await fetch(url);
    const data = await res.json();
    return data.address?.city || data.address?.town || data.address?.county || data.address?.state || 'í˜„ì¬ ìœ„ì¹˜';
  } catch (e) {
    return 'í˜„ì¬ ìœ„ì¹˜';
  }
}

function Onboarding({ onComplete }) {
  const [step, setStep] = useState(0);
  const [profile, setProfile] = useState({ gender: '', birthYear: '', styles: [], customStyles: [] });
  const [customInput, setCustomInput] = useState('');
  const year = new Date().getFullYear();
  const validYear = profile.birthYear && +profile.birthYear >= 1940 && +profile.birthYear <= year - 10;

  const toggleStyle = id => setProfile(p => ({ ...p, styles: p.styles.includes(id) ? p.styles.filter(s => s !== id) : [...p.styles, id] }));
  const addCustom = () => { if (customInput.trim() && !profile.customStyles.includes(customInput.trim())) { setProfile(p => ({ ...p, customStyles: [...p.customStyles, customInput.trim()] })); setCustomInput(''); } };
  const removeCustom = s => setProfile(p => ({ ...p, customStyles: p.customStyles.filter(x => x !== s) }));
  const canNext = () => step === 0 || (step === 1 && profile.gender) || (step === 2 && validYear) || (step === 3 && (profile.styles.length || profile.customStyles.length));

  return (
    <div className="min-h-screen flex flex-col px-6 py-8">
      <div className="flex justify-center gap-2 mb-8">{[0,1,2,3].map(i => <div key={i} className={`progress-dot ${i === step ? 'active' : i < step ? 'completed' : ''}`}/>)}</div>
      <div className="flex-1 flex flex-col justify-center overflow-y-auto">
        {step === 0 && <div className="text-center animate-fade-in"><div className="text-6xl mb-6">ğŸ‘”</div><h1 className="text-3xl font-bold text-white mb-4" style={{fontFamily:'Outfit'}}>ì½”ë””ë©”ì´íŠ¸</h1><p className="text-gray-400 text-lg">AIê°€ ë‚ ì”¨ì™€ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•´<br/>ì™„ë²½í•œ ì½”ë””ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”</p></div>}
        {step === 1 && <div className="animate-fade-in"><h2 className="text-2xl font-bold text-white text-center mb-2">ìŠ¤íƒ€ì¼ ì„±í–¥ ì„ íƒ</h2><p className="text-gray-400 text-center mb-8">ë§ì¶¤ ì¶”ì²œì„ ìœ„í•´ í•„ìš”í•´ìš”</p><div className="flex flex-col gap-3 max-w-sm mx-auto">{[{id:'male',label:'ë‚¨ì„± ìŠ¤íƒ€ì¼',emoji:'ğŸ‘¨',desc:'ë‚¨ì„±ì ì¸ í•'},{id:'female',label:'ì—¬ì„± ìŠ¤íƒ€ì¼',emoji:'ğŸ‘©',desc:'ì—¬ì„±ì ì¸ í•'},{id:'unisex',label:'ìœ ë‹ˆì„¹ìŠ¤',emoji:'ğŸ§‘',desc:'ì  ë”ë¦¬ìŠ¤ ì˜¤ë²„í•'}].map(o=><button key={o.id} onClick={()=>setProfile(p=>({...p,gender:o.id}))} className={`w-full py-4 px-5 rounded-2xl border-2 flex items-center gap-4 transition-all ${profile.gender===o.id?'border-orange-400 bg-orange-400/10':'border-white/10 bg-white/5'}`}><span className="text-3xl">{o.emoji}</span><div className="text-left"><div className="text-white font-medium">{o.label}</div><div className="text-gray-500 text-sm">{o.desc}</div></div></button>)}</div></div>}
        {step === 2 && <div className="animate-fade-in"><h2 className="text-2xl font-bold text-white text-center mb-2">ì¶œìƒì—°ë„ ì…ë ¥</h2><p className="text-gray-400 text-center mb-8">ì—°ë ¹ëŒ€ì— ë§ëŠ” ìŠ¤íƒ€ì¼ ì¶”ì²œ</p><div className="max-w-xs mx-auto"><input type="number" placeholder="ì˜ˆ: 1995" value={profile.birthYear} onChange={e=>setProfile(p=>({...p,birthYear:e.target.value}))}/>{profile.birthYear && <p className={`text-center mt-4 ${validYear?'text-orange-400':'text-red-400 text-sm'}`}>{validYear ? `${year - +profile.birthYear}ì„¸` : 'ì˜¬ë°”ë¥¸ ì—°ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”'}</p>}</div></div>}
        {step === 3 && <div className="animate-fade-in max-h-[55vh] overflow-y-auto"><h2 className="text-2xl font-bold text-white text-center mb-2">ì„ í˜¸ ìŠ¤íƒ€ì¼</h2><p className="text-gray-400 text-center mb-6">ì—¬ëŸ¬ ê°œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥</p>{styleCategories.map((cat,i)=><div key={i} className="mb-5"><h3 className="text-gray-500 text-sm mb-2">{cat.category}</h3><div className="flex flex-wrap gap-2">{cat.options.map(s=><button key={s.id} onClick={()=>toggleStyle(s.id)} className={`style-chip px-3 py-2 rounded-full border-2 flex items-center gap-1.5 text-sm transition-all ${profile.styles.includes(s.id)?'selected':'border-white/10 bg-white/5 text-gray-300'}`}><span>{s.emoji}</span>{s.label}</button>)}</div></div>)}<div className="mt-4 mb-4"><h3 className="text-gray-500 text-sm mb-2">ì§ì ‘ ì…ë ¥</h3><div className="flex gap-2"><input type="text" placeholder="ì›í•˜ëŠ” ìŠ¤íƒ€ì¼" value={customInput} onChange={e=>setCustomInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addCustom()} className="flex-1 text-left text-base px-4"/><button onClick={addCustom} disabled={!customInput.trim()} className="px-4 py-2 bg-orange-500 text-white rounded-xl disabled:opacity-50">ì¶”ê°€</button></div>{profile.customStyles.length>0&&<div className="flex flex-wrap gap-2 mt-3">{profile.customStyles.map((s,i)=><span key={i} className="custom-tag">{s}<button onClick={()=>removeCustom(s)}>Ã—</button></span>)}</div>}</div></div>}
      </div>
      <button onClick={()=>step<3?setStep(step+1):onComplete(profile)} disabled={!canNext()} className={`w-full py-4 rounded-2xl font-semibold text-white mt-6 transition-all ${canNext()?'btn-primary':'bg-gray-700 opacity-50'}`}>{step===3?'ì‹œì‘í•˜ê¸°':'ë‹¤ìŒ'}</button>
    </div>
  );
}

function WeatherCard({ weather, location, loading }) {
  if (loading) {
    return (
      <div className="glass-card rounded-2xl p-5 mb-6">
        <div className="flex items-center justify-center py-8">
          <div className="loading-spinner mr-3" style={{width:24,height:24,borderWidth:2}}/>
          <span className="text-gray-400">ë‚ ì”¨ ì •ë³´ ë¡œë”© ì¤‘...</span>
        </div>
      </div>
    );
  }
  
  if (!weather) {
    return (
      <div className="glass-card rounded-2xl p-5 mb-6">
        <div className="text-center py-4 text-gray-400">
          <p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="text-sm mt-1">ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>
        </div>
      </div>
    );
  }

  return (
    <div className="glass-card rounded-2xl p-5 mb-6 relative overflow-hidden">
      <div className="absolute inset-0" style={{background:'radial-gradient(ellipse at center, rgba(241,154,62,0.15) 0%, transparent 70%)'}}/>
      <div className="relative z-10">
        <div className="flex justify-between mb-3">
          <div className="flex items-center gap-2">
            <span className="text-orange-400"><Icons.Location/></span>
            <span className="text-white font-medium">{location}</span>
            <span className="text-xs text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full">ì‹¤ì‹œê°„</span>
          </div>
          <span className="text-gray-400 text-sm">ì˜¤ëŠ˜</span>
        </div>
        <div className="flex justify-between items-center">
          <div>
            <div className="flex items-baseline">
              <span className="text-5xl font-bold text-white" style={{fontFamily:'Outfit'}}>{weather.temperature}</span>
              <span className="text-2xl text-gray-400">Â°C</span>
            </div>
            <div className="text-gray-400 text-sm mt-1">
              {weather.tempMin}Â° / {weather.tempMax}Â° Â· ì¼êµì°¨ {weather.tempMax - weather.tempMin}Â°
            </div>
          </div>
          <div className="text-right">
            <div className="text-5xl">{weather.icon}</div>
            <div className="text-gray-300 text-sm">{weather.condition}</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function OutfitItem({ item, i }) {
  const emoji = {'ìƒì˜':'ğŸ‘•','í•˜ì˜':'ğŸ‘–','ì•„ìš°í„°':'ğŸ§¥','ì–‘ë§':'ğŸ§¦','ì‹ ë°œ':'ğŸ‘Ÿ','ì†Œí’ˆ':'ğŸ‘œ'};
  return <div className="outfit-item rounded-xl p-4 animate-fade-in" style={{animationDelay:`${i*0.1}s`}}><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center text-2xl">{emoji[item.category]||'ğŸ‘”'}</div><div className="flex-1 min-w-0"><div className="text-xs text-orange-400 font-medium mb-1">{item.category}</div><div className="text-white font-medium truncate">{item.name}</div>{item.detail&&<div className="text-gray-500 text-sm truncate">{item.detail}</div>}</div><Icons.Chevron/></div></div>;
}

// í”Œë ˆì´ìŠ¤í™€ë” ì´ë¯¸ì§€ ì»´í¬ë„ŒíŠ¸
function PlaceholderImage({ outfit, styles }) {
  return (
    <div className="aspect-[3/4] placeholder-image rounded-t-2xl p-6">
      <div className="text-center mb-6">
        <div className="text-6xl mb-3">ğŸ‘”</div>
        <p className="text-gray-300 font-medium">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì½”ë””</p>
        <p className="text-gray-500 text-sm mt-1">{styles}</p>
      </div>
      <div className="space-y-2">
        {outfit?.slice(0, 4).map((item, i) => (
          <div key={i} className="flex items-center gap-3 bg-white/5 rounded-lg p-2">
            <span className="text-xl">{{'ìƒì˜':'ğŸ‘•','í•˜ì˜':'ğŸ‘–','ì•„ìš°í„°':'ğŸ§¥','ì–‘ë§':'ğŸ§¦','ì‹ ë°œ':'ğŸ‘Ÿ','ì†Œí’ˆ':'ğŸ‘œ'}[item.category] || 'ğŸ‘”'}</span>
            <div className="flex-1 min-w-0">
              <p className="text-white text-sm truncate">{item.name}</p>
              <p className="text-gray-500 text-xs truncate">{item.detail}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function HomeScreen({ profile, weather, location, weatherLoading }) {
  const [outfit, setOutfit] = useState(null);
  const [loading, setLoading] = useState(true);
  const [imgLoading, setImgLoading] = useState(false);
  const [reason, setReason] = useState('');
  const [image, setImage] = useState(null);
  const [imgError, setImgError] = useState(null);
  const [imgStatus, setImgStatus] = useState('');

  const styleMap = {}; styleCategories.forEach(c=>c.options.forEach(o=>styleMap[o.id]=o.label));
  const getStyles = () => [...profile.styles.map(s=>styleMap[s]||s),...profile.customStyles].join(', ');
  const getGender = () => profile.gender==='male'?'ë‚¨ì„±':profile.gender==='female'?'ì—¬ì„±':'ìœ ë‹ˆì„¹ìŠ¤';
  const getAge = () => { const a=new Date().getFullYear()-+profile.birthYear; return a<20?'10ëŒ€':a<30?'20ëŒ€':a<40?'30ëŒ€':a<50?'40ëŒ€':'50ëŒ€+'; };

  const genImage = async items => {
    setImgLoading(true); setImage(null); setImgError(null);
    const desc = items.map(i=>`${i.category}:${i.name}(${i.detail})`).join(',');
    const g = profile.gender==='male'?'Korean man':profile.gender==='female'?'Korean woman':'Korean person androgynous style';
    const prompt = `Create a high-quality fashion photograph of a stylish ${g} in their ${getAge()}. Full body shot, modern urban background. The person is wearing: ${desc}. Fashion style: ${getStyles()}, trendy 2025 Korean fashion. Professional photography quality. Do NOT include any text or watermarks in the image.`;
    
    for (const model of IMAGE_MODELS) {
      setImgStatus(`${model.split('-').slice(-2).join('-')} ì‹œë„ ì¤‘...`);
      console.log(`Trying image model: ${model}`);
      
      try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { 
              responseModalities: ['Text', 'Image']
            }
          })
        });
        
        const data = await res.json();
        console.log(`Response from ${model}:`, data);
        
        if (!res.ok) {
          console.log(`Model ${model} error:`, data.error?.message);
          continue;
        }
        
        const parts = data.candidates?.[0]?.content?.parts || [];
        for (const p of parts) {
          if (p.inlineData) {
            setImage(`data:${p.inlineData.mimeType || 'image/png'};base64,${p.inlineData.data}`);
            setImgLoading(false);
            setImgStatus('');
            return;
          }
        }
      } catch (e) {
        console.error(`Error with ${model}:`, e);
        continue;
      }
    }
    
    // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨
    setImgError('ì´ë¯¸ì§€ ìƒì„± API ì ‘ê·¼ ë¶ˆê°€');
    setImgLoading(false);
    setImgStatus('');
  };

  const generate = async () => {
    setLoading(true); setOutfit(null); setImage(null); setImgError(null);
    
    const weatherDesc = weather 
      ? `${weather.condition} ${weather.temperature}Â°C (ìµœì € ${weather.tempMin}Â° / ìµœê³  ${weather.tempMax}Â°)`
      : 'ë‚ ì”¨ ì •ë³´ ì—†ìŒ';
    
    const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ íŒ¨ì…˜ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ì¡°ê±´ì— ë§ëŠ” ì˜¤ëŠ˜ì˜ ì½”ë””ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”.

ì¡°ê±´:
- ë‚ ì”¨: ${weatherDesc}
- ì‚¬ìš©ì: ${getGender()} ìŠ¤íƒ€ì¼ ì„ í˜¸, ${getAge()} (${profile.birthYear}ë…„ìƒ)
- ì„ í˜¸ ìŠ¤íƒ€ì¼: ${getStyles()}
${profile.gender === 'unisex' ? '- ìœ ë‹ˆì„¹ìŠ¤/ì  ë”ë¦¬ìŠ¤ ì˜¤ë²„í• ìŠ¤íƒ€ì¼ë¡œ ì¶”ì²œí•´ì£¼ì„¸ìš”.' : ''}

ì„ í˜¸ ìŠ¤íƒ€ì¼ì˜ íŠ¹ì§•ê³¼ ìµœì‹  íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•˜ì—¬ êµ¬ì²´ì ì¸ ì•„ì´í…œì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{"items":[{"category":"ìƒì˜","name":"êµ¬ì²´ì  ì•„ì´í…œëª…","detail":"ìƒ‰ìƒ/ì†Œì¬/í•"},{"category":"í•˜ì˜","name":"","detail":""},{"category":"ì•„ìš°í„°","name":"","detail":""},{"category":"ì–‘ë§","name":"","detail":""},{"category":"ì‹ ë°œ","name":"","detail":""},{"category":"ì†Œí’ˆ","name":"","detail":""}],"reason":"ì´ ì½”ë”” ì¶”ì²œ ì´ìœ  3-4ë¬¸ì¥"}`;

    try {
      const res = await fetch(`${GEMINI_TEXT_URL}?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.9, maxOutputTokens: 1500 }
        })
      });
      const data = await res.json();
      const match = data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/);
      if (match) {
        const result = JSON.parse(match[0]);
        setOutfit(result.items);
        setReason(result.reason);
        setLoading(false);
        genImage(result.items);
      }
    } catch (e) {
      console.error('Text generation error:', e);
      const fb = [
        { category: 'ìƒì˜', name: 'í™”ì´íŠ¸ ì˜¤ë²„í• ì…”ì¸ ', detail: 'ì½”íŠ¼, ë£¨ì¦ˆí•' },
        { category: 'í•˜ì˜', name: 'ì™€ì´ë“œ ë°ë‹˜ íŒ¬ì¸ ', detail: 'ì¸ë””ê³  ë¸”ë£¨' },
        { category: 'ì•„ìš°í„°', name: 'ë² ì´ì§€ íŠ¸ë Œì¹˜ì½”íŠ¸', detail: 'ë¯¸ë””ì—„ ê¸°ì¥' },
        { category: 'ì–‘ë§', name: 'í™”ì´íŠ¸ í¬ë£¨ì‚­ìŠ¤', detail: 'ì½”íŠ¼' },
        { category: 'ì‹ ë°œ', name: 'í™”ì´íŠ¸ ìŠ¤ë‹ˆì»¤ì¦ˆ', detail: 'ë¯¸ë‹ˆë©€ ë””ìì¸' },
        { category: 'ì†Œí’ˆ', name: 'ë¸”ë™ í† íŠ¸ë°±', detail: 'ë ˆë”' }
      ];
      setOutfit(fb);
      setReason('ê¸°ë³¸ ì¶”ì²œ ì½”ë””ì…ë‹ˆë‹¤. ë‚ ì”¨ì™€ ìŠ¤íƒ€ì¼ì— ë§ê²Œ ì¡°ì •í•´ë³´ì„¸ìš”.');
      setLoading(false);
      genImage(fb);
    }
  };

  useEffect(() => { 
    if (!weatherLoading) generate(); 
  }, [weatherLoading]);

  return (
    <div className="pb-24">
      <WeatherCard weather={weather} location={location} loading={weatherLoading} />
      
      {/* ì½”ë”” ì´ë¯¸ì§€ ì˜ì—­ */}
      <div className="mb-6 glass-card rounded-2xl overflow-hidden">
        {imgLoading ? (
          <div className="aspect-[3/4] flex flex-col items-center justify-center bg-white/5">
            <div className="loading-spinner mb-4"/>
            <p className="text-gray-400 text-sm">AI ì´ë¯¸ì§€ ìƒì„± ì¤‘...</p>
            {imgStatus && <p className="text-orange-400 text-xs mt-2">{imgStatus}</p>}
          </div>
        ) : image ? (
          <div className="relative">
            <img src={image} className="w-full aspect-[3/4] object-cover"/>
            <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 to-transparent p-4">
              <p className="text-white text-sm font-medium">AI ì¶”ì²œ ì½”ë””</p>
              <p className="text-gray-300 text-xs">{getStyles()}</p>
            </div>
          </div>
        ) : imgError ? (
          <div>
            <PlaceholderImage outfit={outfit} styles={getStyles()} />
            <div className="bg-yellow-500/10 border-t border-yellow-500/20 p-3">
              <p className="text-yellow-400 text-xs text-center">
                ğŸ’¡ ì´ë¯¸ì§€ ìƒì„± API ì ‘ê·¼ ì œí•œ - í…ìŠ¤íŠ¸ ì¶”ì²œìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤
              </p>
            </div>
          </div>
        ) : loading ? (
          <div className="aspect-[3/4] flex items-center justify-center bg-white/5">
            <div className="loading-spinner"/>
          </div>
        ) : (
          <PlaceholderImage outfit={outfit} styles={getStyles()} />
        )}
      </div>
      
      {/* ì½”ë”” ì•„ì´í…œ ëª©ë¡ */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-white">ì˜¤ëŠ˜ì˜ ì¶”ì²œ</h2>
        <button onClick={generate} disabled={loading || imgLoading || weatherLoading} className="flex items-center gap-2 text-orange-400 text-sm disabled:opacity-50">
          <Icons.Refresh/>ë‹¤ë¥¸ ìŠ¤íƒ€ì¼
        </button>
      </div>
      
      {loading ? (
        <div className="flex flex-col items-center py-20">
          <div className="loading-spinner mb-4"/>
          <p className="text-gray-400">AIê°€ ë¶„ì„ ì¤‘...</p>
        </div>
      ) : (
        <div className="space-y-3">{outfit?.map((item, i) => <OutfitItem key={i} item={item} i={i}/>)}</div>
      )}
      
      {reason && !loading && (
        <div className="glass-card rounded-xl p-4 mt-4 flex gap-3">
          <span className="text-xl">ğŸ’¡</span>
          <p className="text-gray-300 text-sm">{reason}</p>
        </div>
      )}
      
      {!loading && (
        <button className="w-full btn-primary py-4 rounded-2xl font-semibold text-white mt-6 flex items-center justify-center gap-2">
          <Icons.Cart/>êµ¬ë§¤í•˜ê¸°
        </button>
      )}
    </div>
  );
}

function ClosetScreen() { 
  return (
    <div className="flex flex-col items-center justify-center py-20 text-center">
      <div className="text-6xl mb-4">ğŸ‘•</div>
      <h2 className="text-xl font-bold text-white mb-2">ë‚´ ì˜·ì¥</h2>
      <p className="text-gray-400 mb-6">ê³§ ì—…ë°ì´íŠ¸!</p>
      <button className="btn-secondary px-6 py-3 rounded-xl text-white">ì•Œë¦¼ ë°›ê¸°</button>
    </div>
  ); 
}

function TrendScreen() {
  const trends = [
    { tag: '#ì˜¬ë“œë¨¸ë‹ˆ', desc: 'í´ë˜ì‹ ê³ ê¸‰ ìŠ¤íƒ€ì¼', hot: true },
    { tag: '#ê³ í”„ì½”ì–´', desc: 'ì•„ì›ƒë„ì–´ ê°ì„± íŒ¨ì…˜', hot: true },
    { tag: '#ë¯¸ë‹ˆë©€ì‹œí¬', desc: 'ì ˆì œëœ ìš°ì•„í•¨', hot: true },
    { tag: '#í…Œí¬ì›¨ì–´', desc: 'ë¯¸ë˜ì§€í–¥ ê¸°ëŠ¥ì„±', hot: false },
    { tag: '#Y2K', desc: '2000ë…„ëŒ€ ë ˆíŠ¸ë¡œ', hot: false }
  ];
  return (
    <div className="pb-24">
      <h2 className="text-xl font-bold text-white mb-4">ğŸ”¥ íŠ¸ë Œë“œ</h2>
      <div className="space-y-3">
        {trends.map((t, i) => (
          <div key={i} className="glass-card rounded-xl p-4 flex justify-between items-center">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-orange-400 font-semibold">{t.tag}</span>
                {t.hot && <span className="text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full">HOT</span>}
              </div>
              <p className="text-gray-400 text-sm">{t.desc}</p>
            </div>
            <Icons.Chevron/>
          </div>
        ))}
      </div>
    </div>
  );
}

function ProfileScreen({ profile }) {
  const styleMap = {}; 
  styleCategories.forEach(c => c.options.forEach(o => styleMap[o.id] = o.label));
  const labels = [...profile.styles.map(s => styleMap[s] || s), ...profile.customStyles];
  const gender = profile.gender === 'male' ? 'ë‚¨ì„±' : profile.gender === 'female' ? 'ì—¬ì„±' : 'ìœ ë‹ˆì„¹ìŠ¤';
  const age = new Date().getFullYear() - +profile.birthYear;
  
  return (
    <div className="pb-24">
      <div className="glass-card rounded-2xl p-6 mb-6 text-center">
        <div className="w-20 h-20 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-4xl mx-auto mb-4">
          {profile.gender === 'male' ? 'ğŸ‘¨' : profile.gender === 'female' ? 'ğŸ‘©' : 'ğŸ§‘'}
        </div>
        <h2 className="text-xl font-bold text-white">{gender} Â· {age}ì„¸</h2>
        <p className="text-gray-400">{profile.birthYear}ë…„ìƒ</p>
      </div>
      
      <div className="glass-card rounded-xl p-4 mb-4">
        <p className="text-gray-500 text-sm mb-3">ì„ í˜¸ ìŠ¤íƒ€ì¼</p>
        <div className="flex flex-wrap gap-2">
          {labels.map((s, i) => (
            <span key={i} className="px-3 py-1.5 rounded-full bg-orange-500/20 text-orange-400 text-sm">{s}</span>
          ))}
        </div>
      </div>
      
      <div className="glass-card rounded-xl overflow-hidden">
        {['í”„ë¡œí•„ ìˆ˜ì •', 'ì•Œë¦¼ ì„¤ì •', 'ì•± ì •ë³´'].map((t, i) => (
          <button key={i} className={`w-full px-4 py-4 flex justify-between text-white hover:bg-white/5 ${i ? 'border-t border-white/5' : ''}`}>
            {t}<Icons.Chevron/>
          </button>
        ))}
      </div>
      
      <div className="mt-6 text-center">
        <p className="text-gray-600 text-xs">Powered by Open-Meteo & Gemini AI</p>
      </div>
    </div>
  );
}

function BottomNav({ tab, setTab }) {
  const tabs = [
    { id: 'home', label: 'í™ˆ', Icon: Icons.Home },
    { id: 'closet', label: 'ì˜·ì¥', Icon: Icons.Closet },
    { id: 'trend', label: 'íŠ¸ë Œë“œ', Icon: Icons.Trend },
    { id: 'profile', label: 'í”„ë¡œí•„', Icon: Icons.Profile }
  ];
  return (
    <nav className="fixed bottom-0 inset-x-0 bg-zinc-900/95 backdrop-blur border-t border-white/5 py-2">
      <div className="flex justify-around max-w-lg mx-auto">
        {tabs.map(t => (
          <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center py-2 px-4 ${tab === t.id ? 'text-orange-400' : 'text-gray-500'}`}>
            <t.Icon/><span className="text-xs mt-1">{t.label}</span>
          </button>
        ))}
      </div>
    </nav>
  );
}

function App() {
  const [ready, setReady] = useState(false);
  const [profile, setProfile] = useState(null);
  const [tab, setTab] = useState('home');
  const [weather, setWeather] = useState(null);
  const [location, setLocation] = useState('ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  const [weatherLoading, setWeatherLoading] = useState(true);

  // ì•± ì‹œì‘ ì‹œ ìœ„ì¹˜ + ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    if (ready) {
      setWeatherLoading(true);
      
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude } = pos.coords;
            console.log('Location:', latitude, longitude);
            
            // ë³‘ë ¬ë¡œ ë‚ ì”¨ì™€ ìœ„ì¹˜ëª… ê°€ì ¸ì˜¤ê¸°
            const [weatherData, locationName] = await Promise.all([
              fetchWeather(latitude, longitude),
              fetchLocationName(latitude, longitude)
            ]);
            
            setWeather(weatherData);
            setLocation(locationName);
            setWeatherLoading(false);
          },
          async (err) => {
            console.log('Geolocation error:', err);
            // ê¸°ë³¸ ìœ„ì¹˜: ì„œìš¸
            const [weatherData] = await Promise.all([
              fetchWeather(37.5665, 126.9780)
            ]);
            setWeather(weatherData);
            setLocation('ì„œìš¸ (ê¸°ë³¸)');
            setWeatherLoading(false);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        // Geolocation ë¯¸ì§€ì›: ì„œìš¸ ê¸°ë³¸
        fetchWeather(37.5665, 126.9780).then(data => {
          setWeather(data);
          setLocation('ì„œìš¸ (ê¸°ë³¸)');
          setWeatherLoading(false);
        });
      }
    }
  }, [ready]);

  if (!ready) return <Onboarding onComplete={p => { setProfile(p); setReady(true); }} />;

  return (
    <div className="min-h-screen max-w-lg mx-auto">
      <header className="px-6 py-4 flex justify-between items-center">
        <h1 className="text-xl font-bold text-white" style={{ fontFamily: 'Outfit' }}>ì½”ë””ë©”ì´íŠ¸</h1>
        <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">ğŸ””</div>
      </header>
      <main className="px-6">
        {tab === 'home' && <HomeScreen profile={profile} weather={weather} location={location} weatherLoading={weatherLoading} />}
        {tab === 'closet' && <ClosetScreen />}
        {tab === 'trend' && <TrendScreen />}
        {tab === 'profile' && <ProfileScreen profile={profile} />}
      </main>
      <BottomNav tab={tab} setTab={setTab} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
